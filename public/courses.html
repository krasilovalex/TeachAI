<script>
  function isDark(hexColor) {
    const r = parseInt(hexColor.substr(1, 2), 16);
    const g = parseInt(hexColor.substr(3, 2), 16);
    const b = parseInt(hexColor.substr(5, 2), 16);
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    return brightness < 128;
  }

  function applyTheme() {
    const tg = window.Telegram.WebApp;
    const theme = tg.themeParams || {};
    const isDarkMode = isDark(theme.secondary_bg_color || '#ffffff');

    if (!isDarkMode) return;

    const textColor = theme.text_color || '#000000';
    const hintColor = theme.hint_color || '#999999';
    const linkColor = theme.link_color || '#0000ee';
    const buttonColor = theme.button_color || '#C8F7FF';
    const buttonTextColor = theme.button_text_color || '#000';

    const style = `
      body, .footer {
        color: ${textColor} !important;
      }
      .lesson-title, .modal-header h5, .card-title, .nav-title {
        color: ${textColor} !important;
      }
      .modal-content {
        background-color: ${theme.secondary_bg_color} !important;
        color: ${textColor} !important;
      }
      .btn, button {
        background-color: ${buttonColor} !important;
        color: ${buttonTextColor} !important;
      }
      a {
        color: ${linkColor} !important;
      }
      .toast {
        background-color: ${hintColor} !important;
        color: ${textColor} !important;
      button:not(.dom-btn):not(.nfi-help) {
        background-color: ${buttonColor} !important;
        color: ${buttonTextColor} !important;
      }
    `;

    document.getElementById('theme-style').innerHTML = style;
  }

  window.addEventListener('DOMContentLoaded', applyTheme);
</script>
